_websocket.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .log {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-family: monospace;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .flex-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        input[type="number"], input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .connected {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .disconnected {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Test Dashboard</h1>
        
        <!-- Connection Controls -->
        <div class="card">
            <h2>WebSocket Connections <span id="generalStatus" class="status disconnected">Disconnected</span></h2>
            <div class="flex-container">
                <button onclick="connectGeneral()">Connect General</button>
                <button onclick="connectMotor()">Connect Motor</button>
                <button onclick="connectPID()">Connect PID</button>
                <button onclick="connectTrajectory()">Connect Trajectory</button>
                <button onclick="disconnectAll()">Disconnect All</button>
            </div>
        </div>
        
        <!-- Data Sending Controls -->
        <div class="card">
            <h2>Send Robot Data</h2>
            
            <h3>Encoder Data:</h3>
            <div class="flex-container">
                <input type="number" id="rpm1" placeholder="RPM 1" value="100">
                <input type="number" id="rpm2" placeholder="RPM 2" value="120">
                <input type="number" id="rpm3" placeholder="RPM 3" value="80">
                <button onclick="sendEncoderData()">Send Encoder Data</button>
            </div>
            
            <h3>IMU Data:</h3>
            <div class="flex-container">
                <input type="number" id="roll" placeholder="Roll" value="2.5" step="0.1">
                <input type="number" id="pitch" placeholder="Pitch" value="1.2" step="0.1">
                <input type="number" id="yaw" placeholder="Yaw" value="45" step="0.1">
                <button onclick="sendIMUData()">Send IMU Data</button>
            </div>
            
            <h3>Motor Control:</h3>
            <div class="flex-container">
                <input type="text" id="robotId" placeholder="Robot ID" value="robot01">
                <input type="number" id="speed1" placeholder="Speed 1" value="50">
                <input type="number" id="speed2" placeholder="Speed 2" value="60">
                <input type="number" id="speed3" placeholder="Speed 3" value="40">
                <button onclick="sendMotorControl()">Send Motor Control</button>
                <button onclick="sendEmergencyStop()" style="background-color: #f44336;">EMERGENCY STOP</button>
            </div>
            
            <h3>PID Settings:</h3>
            <div class="flex-container">
                <select id="motorId">
                    <option value="1">Motor 1</option>
                    <option value="2">Motor 2</option>
                    <option value="3">Motor 3</option>
                </select>
                <input type="number" id="pValue" placeholder="P" value="0.5" step="0.01">
                <input type="number" id="iValue" placeholder="I" value="0.2" step="0.01">
                <input type="number" id="dValue" placeholder="D" value="0.05" step="0.01">
                <button onclick="sendPIDSettings()">Send PID Settings</button>
                <button onclick="getPIDSettings()">Get Current PID</button>
            </div>
        </div>
        
        <!-- Log Window -->
        <div class="card">
            <h2>Connection Log</h2>
            <div id="logWindow" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <!-- Received Data -->
        <div class="card">
            <h2>Received Data</h2>
            <div id="receivedData" class="log"></div>
            <button onclick="clearReceived()">Clear Received</button>
        </div>
    </div>
    
    <script>
        // WebSocket connections
        let generalWS = null;
        let motorWS = null;
        let pidWS = null;
        let trajectoryWS = null;
        let robot1WS = null;
        let robot2WS = null;
        let robot3WS = null;
        let robot4WS = null;
        let serverWS = null;
        
        // Connection functions
        function connectGeneral() {
            try {
                generalWS = new WebSocket(`ws://${window.location.hostname}:8000/ws`);
                
                generalWS.onopen = () => {
                    logMessage("General WebSocket connected");
                    document.getElementById("generalStatus").textContent = "Connected";
                    document.getElementById("generalStatus").className = "status connected";
                    
                    // Set up heartbeat
                    setInterval(() => {
                        if (generalWS && generalWS.readyState === WebSocket.OPEN) {
                            generalWS.send(JSON.stringify({ type: "pong" }));
                        }
                    }, 25000);
                };
                
                generalWS.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === "ping") {
                        // Respond to heartbeat ping
                        generalWS.send(JSON.stringify({ type: "pong" }));
                        return;
                    }
                    displayReceivedData(`General: ${event.data}`);
                };
                
                generalWS.onclose = () => {
                    logMessage("General WebSocket disconnected");
                    document.getElementById("generalStatus").textContent = "Disconnected";
                    document.getElementById("generalStatus").className = "status disconnected";
                };
                
                generalWS.onerror = (error) => {
                    logMessage(`General WebSocket error: ${error}`);
                };
            } catch (error) {
                logMessage(`Error connecting to general WebSocket: ${error.message}`);
            }
        }
        
        function connectMotor() {
            // Thay thế bằng hàm chọn robot cụ thể
            const robotId = document.getElementById("robotId").value;
            connectToRobot(robotId);
        }
        
        function connectPID() {
            try {
                pidWS = new WebSocket(`ws://${window.location.hostname}:8000/ws/pid`);
                
                pidWS.onopen = () => {
                    logMessage("PID WebSocket connected");
                };
                
                pidWS.onmessage = (event) => {
                    displayReceivedData(`PID: ${event.data}`);
                };
                
                pidWS.onclose = () => {
                    logMessage("PID WebSocket disconnected");
                };
            } catch (error) {
                logMessage(`Error connecting to PID WebSocket: ${error.message}`);
            }
        }
        
        function connectTrajectory() {
            try {
                trajectoryWS = new WebSocket(`ws://${window.location.hostname}:8000/ws/trajectory`);
                
                trajectoryWS.onopen = () => {
                    logMessage("Trajectory WebSocket connected");
                };
                
                trajectoryWS.onmessage = (event) => {
                    // Only log the first part to avoid flooding the display
                    const data = JSON.parse(event.data);
                    let displayData = { ...data };
                    if (data.trajectory && data.trajectory.x && data.trajectory.x.length > 5) {
                        displayData.trajectory = {
                            ...data.trajectory,
                            x: data.trajectory.x.slice(0, 5).concat(['...']),
                            y: data.trajectory.y.slice(0, 5).concat(['...'])
                        };
                    }
                    displayReceivedData(`Trajectory: ${JSON.stringify(displayData, null, 2)}`);
                };
                
                trajectoryWS.onclose = () => {
                    logMessage("Trajectory WebSocket disconnected");
                };
            } catch (error) {
                logMessage(`Error connecting to trajectory WebSocket: ${error.message}`);
            }
        }
        
        function connectRobot1() {
            try {
                robot1WS = new WebSocket(`ws://${window.location.hostname}:8000/ws/robot1`);
                
                robot1WS.onopen = () => {
                    logMessage("Robot 1 WebSocket connected");
                };
                
                robot1WS.onmessage = (event) => {
                    displayReceivedData(`Robot 1: ${event.data}`);
                };
                
                robot1WS.onclose = () => {
                    logMessage("Robot 1 WebSocket disconnected");
                };
            } catch (error) {
                logMessage(`Error connecting to Robot 1 WebSocket: ${error.message}`);
            }
        }
        
        function connectToRobot(robotId) {
            try {
                const ws = new WebSocket(`ws://${window.location.hostname}:8000/ws/${robotId}`);
                
                // Chọn biến để lưu kết nối dựa trên robotId
                if (robotId === 'robot1') robot1WS = ws;
                else if (robotId === 'robot2') robot2WS = ws;
                else if (robotId === 'robot3') robot3WS = ws;
                else if (robotId === 'robot4') robot4WS = ws;
                
                ws.onopen = () => {
                    logMessage(`${robotId} WebSocket connected`);
                };
                
                ws.onmessage = (event) => {
                    displayReceivedData(`${robotId}: ${event.data}`);
                };
                
                ws.onclose = () => {
                    logMessage(`${robotId} WebSocket disconnected`);
                };
            } catch (error) {
                logMessage(`Error connecting to ${robotId}: ${error.message}`);
            }
        }
        
        function disconnectAll() {
            if (generalWS) {
                generalWS.close();
                generalWS = null;
            }
            
            if (motorWS) {
                motorWS.close();
                motorWS = null;
            }
            
            if (pidWS) {
                pidWS.close();
                pidWS = null;
            }
            
            if (trajectoryWS) {
                trajectoryWS.close();
                trajectoryWS = null;
            }
            
            if (robot1WS) {
                robot1WS.close();
                robot1WS = null;
            }
            
            if (robot2WS) {
                robot2WS.close();
                robot2WS = null;
            }
            
            if (robot3WS) {
                robot3WS.close();
                robot3WS = null;
            }
            
            if (robot4WS) {
                robot4WS.close();
                robot4WS = null;
            }
            
            if (serverWS) {
                serverWS.close();
                serverWS = null;
            }
            
            logMessage("All WebSocket connections closed");
            document.getElementById("generalStatus").textContent = "Disconnected";
            document.getElementById("generalStatus").className = "status disconnected";
        }
        
        // Data sending functions
        function sendEncoderData() {
            if (!generalWS || generalWS.readyState !== WebSocket.OPEN) {
                logMessage("Cannot send encoder data: General WebSocket not connected");
                return;
            }
            
            const rpm1 = parseFloat(document.getElementById("rpm1").value);
            const rpm2 = parseFloat(document.getElementById("rpm2").value);
            const rpm3 = parseFloat(document.getElementById("rpm3").value);
            
            const encoderData = {
                type: "encoder_data",
                values: [1000, 1050, 1100], // Mock encoder values
                rpm: [rpm1, rpm2, rpm3],
                timestamp: Date.now() / 1000
            };
            
            generalWS.send(JSON.stringify(encoderData));
            logMessage(`Sent encoder data: RPM [${rpm1}, ${rpm2}, ${rpm3}]`);
        }
        
        function sendIMUData() {
            if (!generalWS || generalWS.readyState !== WebSocket.OPEN) {
                logMessage("Cannot send IMU data: General WebSocket not connected");
                return;
            }
            
            const roll = parseFloat(document.getElementById("roll").value);
            const pitch = parseFloat(document.getElementById("pitch").value);
            const yaw = parseFloat(document.getElementById("yaw").value);
            
            const imuData = {
                type: "imu_data",
                orientation: {
                    roll: roll,
                    pitch: pitch,
                    yaw: yaw
                },
                acceleration: {
                    x: Math.random() * 2 - 1,
                    y: Math.random() * 2 - 1,
                    z: 9.8 + (Math.random() * 0.2 - 0.1)
                },
                angular_velocity: {
                    x: Math.random() * 0.2 - 0.1,
                    y: Math.random() * 0.2 - 0.1,
                    z: Math.random() * 0.2 - 0.1
                },
                timestamp: Date.now() / 1000
            };
            
            generalWS.send(JSON.stringify(imuData));
            logMessage(`Sent IMU data: Roll ${roll}, Pitch ${pitch}, Yaw ${yaw}`);
        }
        
        function sendMotorControl() {
            if (!motorWS || motorWS.readyState !== WebSocket.OPEN) {
                logMessage("Cannot send motor control: Motor WebSocket not connected");
                return;
            }
            
            const robotId = document.getElementById("robotId").value;
            const speed1 = parseFloat(document.getElementById("speed1").value);
            const speed2 = parseFloat(document.getElementById("speed2").value);
            const speed3 = parseFloat(document.getElementById("speed3").value);
            
            const motorControl = {
                type: "motor_control",
                robot_id: robotId,
                speeds: [speed1, speed2, speed3],
                command_id: `cmd_${Date.now()}`
            };
            
            motorWS.send(JSON.stringify(motorControl));
            logMessage(`Sent motor control: Speeds [${speed1}, ${speed2}, ${speed3}]`);
        }
        
        function sendEmergencyStop() {
            if (!motorWS || motorWS.readyState !== WebSocket.OPEN) {
                logMessage("Cannot send emergency stop: Motor WebSocket not connected");
                return;
            }
            
            const robotId = document.getElementById("robotId").value;
            
            const stopCommand = {
                type: "emergency_stop",
                robot_id: robotId,
                command_id: `stop_${Date.now()}`
            };
            
            motorWS.send(JSON.stringify(stopCommand));
            logMessage(`Sent emergency stop command for robot ${robotId}`);
        }
        
        function sendPIDSettings() {
            const robotId = document.getElementById("robotId").value;
            const connection = robotId === "robot1" ? robot1WS : 
                              robotId === "robot2" ? robot2WS :
                              robotId === "robot3" ? robot3WS : robot4WS;
                              
            if (!connection || connection.readyState !== WebSocket.OPEN) {
                logMessage(`Cannot send PID settings: ${robotId} WebSocket not connected`);
                return;
            }
            
            const motorId = parseInt(document.getElementById("motorId").value);
            const pValue = parseFloat(document.getElementById("pValue").value);
            const iValue = parseFloat(document.getElementById("iValue").value);
            const dValue = parseFloat(document.getElementById("dValue").value);
            
            const pidSettings = {
                type: "pid",
                action: "set_config",
                motor_id: motorId,
                p: pValue,
                i: iValue,
                d: dValue
            };
            
            connection.send(JSON.stringify(pidSettings));
            logMessage(`Sent PID settings to ${robotId} for Motor ${motorId}: P=${pValue}, I=${iValue}, D=${dValue}`);
        }
        
        function getPIDSettings() {
            if (!pidWS || pidWS.readyState !== WebSocket.OPEN) {
                logMessage("Cannot get PID settings: PID WebSocket not connected");
                return;
            }
            
            const motorId = parseInt(document.getElementById("motorId").value);
            
            const request = {
                type: "get_pid_config",
                motor_id: motorId
            };
            
            pidWS.send(JSON.stringify(request));
            logMessage(`Requested current PID settings for Motor ${motorId}`);
        }
        
        // Utility functions
        function logMessage(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            const logWindow = document.getElementById("logWindow");
            logWindow.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logWindow.scrollTop = logWindow.scrollHeight;
        }
        
        function displayReceivedData(data) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            const receivedWindow = document.getElementById("receivedData");
            receivedWindow.innerHTML += `<div>[${timestamp}] ${data}</div>`;
            receivedWindow.scrollTop = receivedWindow.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById("logWindow").innerHTML = "";
        }
        
        function clearReceived() {
            document.getElementById("receivedData").innerHTML = "";
        }
        
        // Auto-connect on page load
        window.onload = function() {
            // Wait a moment before connecting to make sure the page is fully loaded
            setTimeout(() => {
                connectGeneral();
            }, 500);
        };
    </script>
</body>
</html>